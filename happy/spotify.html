<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="cwh/favicon.ico">
    <title>Spotify - Web Player: Music for everyone</title>
    <link rel="stylesheet" href="utility.css">
</head>

<body>
    <div class="container flex bg-black">
        <div class="left bg-black">
            <div class="close">
                <img class="invert close" src="cwh/img/close.svg" alt="">
            </div>
            <div class="home p-1 rounded m-1">
                <div class="logo invert">
                    <img src="cwh/img/logo.svg" alt="">
                </div>
                <ul class="homelist">
                    <li><img class="invert" src="cwh/img/home.svg" alt="Home" srcset="">Home</li>
                    <li><img class="invert" src="cwh/img/search.svg" alt="Search">Search</li>
                </ul>
            </div>

            <div class="library rounded m-1 p-1">
                <div class="heading">
                    <img class="invert" src="cwh/img/playlist.svg" alt="">
                    <h2>your library</h2>
                </div>
                <div class="songlist">
                    <ul>
                        <li>
                            <img class="invert" src="cwh/img/music.svg" alt="">
                            <div class="info">
                                <div>Song Name</div>

                            </div>
                            <span>Play Now</span>
                            <img class="invert" src="cwh/img/play.svg" alt="">
                        </li>
                    </ul>
                </div>
                <div class="footer">
                    <div>
                        <a href="https://www.spotify.com/in-en/legal/" data-testid="textLink"
                            id=""><span>Legal</span></a>
                    </div>
                    <div>
                        <a href="https://www.spotify.com/in-en/legal/privacy-policy/" data-testid="textLink"
                            id=""><span>Privacy Policy</span></a>
                    </div>
                    <div>
                        <a href="https://www.spotify.com/in-en/legal/cookies-policy/" data-testid="textLink"
                            id=""><span>Cookies</span></a>
                    </div>
                    <div>
                        <a href="https://www.spotify.com/in-en/legal/privacy-policy/#s3" data-testid="textLink"
                            id=""><span>About Ads</span></a>
                    </div>
                    <div>
                        <a href="https://www.spotify.com/in-en/accessibility/" data-testid="textLink"
                            id=""><span>Accessibility</span></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="right m-1 p-1">

            <div class="header">
                <div class="nav">

                    <img class="hamburger invert" src="cwh/img/hamburger.svg" alt="">

                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff"
                        fill="none">
                        <path d="M15 6C15 6 9.00001 10.4189 9 12C8.99999 13.5812 15 18 15 18" stroke="currentColor"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff"
                        fill="none">
                        <path d="M9.00005 6C9.00005 6 15 10.4189 15 12C15 13.5812 9 18 9 18" stroke="#ffffff"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </div>
                <div class="buttons">
                    <button class="signup">Sign-up</button>
                    <button class="login">Login</button>
                </div>
            </div>
            <div class="spotifyPlaylist">
                <h1>Spotify Playlist</h1>
                <div class="cardContainer" id="cardContainer">

                </div>

            </div>
            <div class="playbar">
                <div class="seekbar">
                    <div class="circle">

                    </div>
                </div>
                <div class="songinfo">

                </div>
                <div class="songbuttons">
                    <img id="previous" width="30" src="cwh/img/prevsong.svg" alt="" srcset="">
                    <img id="play" width="30" src="cwh/img/play.svg" alt="">
                    <img id="next" width="30" src="cwh/img/nextsong.svg" alt="">
                    <div class="songtime">

                    </div>
                    <div class="volumewrapper">

                        <div class="volume">
                            <img src="cwh/img/volume.svg" alt="">
                        </div>
                        <div class="range">
                            <input type="range" name="volume" min="0" max="100" value="100">
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>
    <script>
        let folder = ""
        console.log("let's write javascript");
        let songs = "";
        let currentAudio = null;
        let play = document.querySelector("#play")
        async function getSongs() {
            const res = await fetch("http://127.0.0.1:5500/spotify/happy");
            const html = await res.text();

            // Parse fetched HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Now query the remote page's DOM
            const links = doc.querySelectorAll('#files a');
            const songs = Array.from(links)
                .filter(a => a.textContent.trim() !== '..')
                .map(a => ({
                    name: a.textContent.trim(),
                    url: a.href
                }));

            return songs;
        }
        const playMusic = (songName) => {
            // Stop any currently playing song
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            play.src = "cwh/img/pause.svg"
            const fullFileName = encodeURIComponent(songName + ".mp3");
            const url = `http://127.0.0.1:5500/spotify/happy/${fullFileName}`;
            currentAudio = new Audio(url);

            currentAudio.play().then(() => {
                console.log("Playing:", songName);
            }).catch(err => {
                console.error("Playback failed:", err);
            });
            document.querySelector(".songinfo").innerHTML = songName
            document.querySelector(".songtime").innerHTML = "00/00"
            currentAudio.addEventListener("timeupdate", (a) => {
                console.log(currentAudio.currentTime, currentAudio.duration);
                document.querySelector(".songtime").innerHTML = `${formatTime(currentAudio.currentTime)}|${formatTime(currentAudio.duration)}`
                document.querySelector(".circle").style.left = (currentAudio.currentTime / currentAudio.duration) * 100 + "%"
            })

        };
        function formatTime(seconds) {
            if (isNaN(seconds)) return "00:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function cleanSongName(fileUrl) {
            const rawName = fileUrl.split('/').pop().replace(/\.mp3$/i, '');
            return decodeURIComponent(rawName);
        }

        async function fetchSongsFromFolder(folder) {
            // Fetch songs from the selected folder
            const res = await fetch(`http://127.0.0.1:5500/spotify/${folder}`);
            const html = await res.text();

            // Parse fetched HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Query the remote page's DOM for song links
            const links = doc.querySelectorAll('#files a');
            songs = Array.from(links)
                .filter(a => a.textContent.trim() !== '..')
                .map(a => ({
                    name: a.textContent.trim(),
                    url: a.href
                }));

            // Update the song list UI
            const songul = document.querySelector(".songlist ul");
            songul.innerHTML = ""; // Clear previous songs
            for (const song of songs) {
                const filename = decodeURIComponent(song.url.split('/').pop());
                const cleanName = filename.replace(/\.mp3$/i, '');

                songul.innerHTML += `
            <li>
                <img class="invert" src="cwh/img/music.svg" alt="">
                <div class="info">
                    <div>${cleanName}</div>
                </div>
                <img class="invert" src="cwh/img/play.svg" alt="Play">
            </li>
        `;
            }
            // Add click listeners to new song items
            Array.from(document.querySelectorAll(".songlist li")).forEach(e => {
                e.addEventListener("click", () => {
                    const songName = e.querySelector(".info > div").textContent.trim();
                    playMusic(songName);
                });
            });

            // Play the first song in the new folder
            if (songs.length > 0) {
                const firstCleanName = cleanSongName(songs[0].url);
                playMusic(firstCleanName);
            }
        }

        async function main() {

            songs = await getSongs()
            console.log(songs);
            var audio = new Audio(songs[0].url);
            const firstCleanName = cleanSongName(songs[0].url);
            playMusic(firstCleanName);
            play.src = "cwh/img/play.svg";

            songul = document.querySelector(".songlist ul")
            for (const song of songs) {
                const filename = decodeURIComponent(song.url.split('/').pop());
                const cleanName = filename.replace(/\.mp3$/i, '');

                songul.innerHTML += `
        <li>
            <img class="invert" src="cwh/img/music.svg" alt="">
            <div class="info">
                <div>${cleanName}</div>
            </div>

            <img class="invert" src="cwh/img/play.svg" alt="Play">
        </li>
    `;
            }
            Array.from(document.querySelectorAll(".songlist li")
            ).forEach(e => {
                e.addEventListener("click", () => {
                    const songName = e.querySelector(".info > div").textContent.trim();
                    playMusic(songName);
                    console.log(songName);

                });
            });
            // audio.pause()

        }
        play.addEventListener("click", () => {
            if (!currentAudio) return; // No song has been played yet

            if (currentAudio.paused) {
                currentAudio.play();
                play.src = "cwh/img/pause.svg";
            } else {
                currentAudio.pause();
                play.src = "cwh/img/play.svg";
            }

        });
        //seekbar event listener
        document.querySelector(".seekbar").addEventListener("click", (e) => {
            let percent = (e.offsetX / e.target.getBoundingClientRect().width) * 100
            document.querySelector(".circle").style.left = percent + "%";
            currentAudio.currentTime = (currentAudio.duration) * percent / 100
        })
        document.querySelector(".hamburger").addEventListener("click", () => {
            document.querySelector(".left").style.left = "0"
        })
        document.querySelector(".close").addEventListener("click", () => {
            document.querySelector(".left").style.left = "-100%"
        })
        main()
        document.querySelector("#previous").addEventListener("click", () => {
            if (!currentAudio) return;

            let rawFilename = currentAudio.src.split("/").pop(); // Get the file name
            let currentCleanName = cleanSongName(rawFilename);   // Clean the name

            let cleanSongNames = songs.map(song => cleanSongName(song.url)); // All clean names
            let index = cleanSongNames.indexOf(currentCleanName);

            if (index > 0) {
                const prevCleanName = cleanSongName(songs[index - 1].url);
                playMusic(prevCleanName);
            }
        });

        document.querySelector("#next").addEventListener("click", () => {
            if (!currentAudio) return;

            let rawFilename = currentAudio.src.split("/").pop();
            let currentCleanName = cleanSongName(rawFilename);

            let cleanSongNames = songs.map(song => cleanSongName(song.url));
            let currentIndex = cleanSongNames.indexOf(currentCleanName);

            if (currentIndex !== -1) {
                let nextIndex = (currentIndex + 1) % songs.length;
                const nextCleanName = cleanSongName(songs[nextIndex].url);
                playMusic(nextCleanName);
            } else {
                console.log("Current song not found for next button. Playing first song.");
                if (songs.length > 0) {
                    const firstCleanName = cleanSongName(songs[0].url);
                    playMusic(firstCleanName);
                }
            }
        });

        document.querySelector(".range input").addEventListener("input", (e) => {
            const volume = parseFloat(e.target.value);
            const newVolume = volume / 100
            if (currentAudio && !isNaN(currentAudio.duration)) {
                currentAudio.volume = newVolume;
            }
        })
        const playlists = [
            {
                name: "Happy Hits!",
                description: "Hits to boost your mood and fill you with...",
                image: "cover/happy.jpg",
                folder: "cs"
            },
            {
                name: "Lofi Chill",
                description: "Relax and study with these lofi tracks...",
                image: "cover/chill.jpg",
                folder: "Chill_(mood)"
            },
            {
                name: "Rock Anthems",
                description: "Guitar legends and epic rock songs...",
                image: "cover/dark.jpg",
                folder: "Dark_(mood)"
            },

        ];

        const cardContainer = document.getElementById("cardContainer");

        playlists.forEach(playlist => {
            const card = document.createElement("div");
            card.classList.add("card");
            card.setAttribute("data-folder", playlist.folder);

            card.innerHTML = `
        <div class="play">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36"
                color="#000000" fill="none">
                <circle cx="12" cy="12" r="10" stroke="#ffffff" stroke-width="2" fill="#1DB954"></circle>
                <path
                    d="M9.5 11.1998V12.8002C9.5 14.3195 9.5 15.0791 9.95576 15.3862C10.4115 15.6932 11.0348 15.3535 12.2815 14.6741L13.7497 13.8738C15.2499 13.0562 16 12.6474 16 12C16 11.3526 15.2499 10.9438 13.7497 10.1262L12.2815 9.32594C11.0348 8.6465 10.4115 8.30678 9.95576 8.61382C9.5 8.92086 9.5 9.6805 9.5 11.1998Z"
                    fill="#000000"></path>
            </svg>
        </div>
        <img src="${playlist.image}" alt="">
        <h2>${playlist.name}</h2>
        <p>${playlist.description}</p>
    `;
    
    cardContainer.appendChild(card);
    
                card.addEventListener("click", () => {
                    fetchSongsFromFolder(playlist.folder);
                    console.log('card clicked');
                    
                });
});

    </script>
</body>

</html>